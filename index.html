<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Pro - Rotación Total</title>
    <style>
        :root { --primary: #1e40af; --secondary: #10b981; --danger: #dc2626; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; color: #1e293b; }
        nav { background: #1e293b; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; }
        .tab-btn { background: none; border: none; color: #94a3b8; padding: 15px; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid var(--secondary); }
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .card.active { display: block; }
        textarea { width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .btn { cursor: pointer; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 10px; }
        .btn-add { background: var(--primary); color: white; width: 100%; }
        .btn-gen { background: var(--secondary); color: white; width: 100%; font-size: 1.1rem; }
        .btn-danger { background: var(--danger); color: white; }
        .match-card { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; background: white; overflow: hidden; }
        .match-header { background: #f8fafc; padding: 8px 15px; display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid #e2e8f0; }
        .match-body { padding: 15px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; text-align: center; }
        .score-input { width: 40px; text-align: center; font-weight: bold; }
        .player-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" onclick="showTab('jugadores')">JUGADORES</button>
    <button class="tab-btn" onclick="showTab('canchas')">CANCHAS / GEN</button>
    <button class="tab-btn" onclick="showTab('fixture')">FIXTURE</button>
</nav>

<div class="container">
    <div id="jugadores" class="card active">
        <h3>Carga de Jugadores</h3>
        <textarea id="bulk" placeholder="Nombre, Categoria (Ej: German, 7)"></textarea>
        <button class="btn btn-add" onclick="importPlayers()">Importar Lista</button>
        <div id="pList" style="margin-top:20px"></div>
        <button class="btn btn-danger" onclick="clearAll()">Borrar Todo</button>
    </div>

    <div id="canchas" class="card">
        <h3>Canchas</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px">
            <input type="text" id="cn" placeholder="Cancha 1" style="flex:1">
            <input type="time" id="ct" value="18:00">
            <button class="btn btn-add" onclick="addCourt()" style="margin:0; width:auto"> + </button>
        </div>
        <div id="cList"></div>
        <hr>
        <button class="btn btn-gen" onclick="generate()">GENERAR FIXTURE SIN REPETICIONES</button>
    </div>

    <div id="fixture" class="card">
        <div id="fContent"></div>
    </div>
</div>

<script>
    let players = JSON.parse(localStorage.getItem('p_v4')) || [];
    let courts = JSON.parse(localStorage.getItem('c_v4')) || [];
    let matches = [];

    function showTab(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
        if(id === 'fixture') renderFixture();
    }

    function importPlayers() {
        document.getElementById('bulk').value.split('\n').forEach(l => {
            let [n, c] = l.split(',');
            if(n && c) players.push({id: Math.random().toString(36).substr(2,9), name: n.trim(), cat: parseInt(c), played: 0, last: -1, partners: []});
        });
        document.getElementById('bulk').value = '';
        save(); renderPlayers();
    }

    function renderPlayers() {
        document.getElementById('pList').innerHTML = players.map((p, i) => `
            <div class="player-item">${p.name} (Cat ${p.cat}) <span onclick="removePlayer(${i})" style="color:red; cursor:pointer">✕</span></div>
        `).join('');
    }

    function addCourt() {
        courts.push({name: document.getElementById('cn').value || 'Cancha', time: document.getElementById('ct').value});
        save(); renderCourts();
    }

    function renderCourts() {
        document.getElementById('cList').innerHTML = courts.map((c, i) => `
            <div class="player-item">${c.name} - ${c.time}hs <span onclick="removeCourt(${i})" style="color:red; cursor:pointer">✕</span></div>
        `).join('');
    }

    function removePlayer(i) { players.splice(i,1); save(); renderPlayers(); }
    function removeCourt(i) { courts.splice(i,1); save(); renderCourts(); }
    function clearAll() { if(confirm("¿Borrar todo?")) { players=[]; matches=[]; save(); renderPlayers(); } }
    function save() { localStorage.setItem('p_v4', JSON.stringify(players)); localStorage.setItem('c_v4', JSON.stringify(courts)); }

    function generate() {
        if(players.length < 4) return alert("Mínimo 4 jugadores");
        matches = [];
        players.forEach(p => { p.played = 0; p.last = -1; p.partners = []; });

        let slots = [];
        courts.forEach(c => {
            let [h, m] = c.time.split(':').map(Number);
            for(let i=0; i<4; i++) { // Generamos 4 turnos de 20 min
                slots.push({ mins: (h*60+m) + (i*20), cName: c.name, time: "" });
            }
        });
        slots.sort((a,b) => a.mins - b.mins);

        slots.forEach(slot => {
            let h = Math.floor(slot.mins/60);
            let m = slot.mins%60;
            slot.time = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;

            let busy = new Set();
            matches.filter(m => m.mins === slot.mins).forEach(m => [...m.t1, ...m.t2].forEach(p => busy.add(p.id)));

            let pool = players.filter(p => !busy.has(p.id));
            pool.sort((a,b) => a.played - b.played || a.last - b.last);

            if(pool.length >= 4) {
                // SELECCIÓN CON RESTRICCIÓN DE COMPAÑERO
                let p1 = pool.shift();
                let p2Index = pool.findIndex(x => !p1.partners.includes(x.id));
                if(p2Index === -1) p2Index = 0; // Fallback si es matemáticamente imposible
                let p2 = pool.splice(p2Index, 1)[0];

                let p3 = pool.shift();
                let p4Index = pool.findIndex(x => !p3.partners.includes(x.id));
                if(p4Index === -1) p4Index = 0;
                let p4 = pool.splice(p4Index, 1)[0];

                let teamA = [p1, p2];
                let teamB = [p3, p4];

                // MEZCLA DE CATEGORÍAS (BALANCEO)
                let all = [...teamA, ...teamB].sort((a,b) => a.cat - b.cat);
                // Forzamos: El mejor con el peor (si no jugaron juntos)
                if(!all[0].partners.includes(all[3].id)) {
                    teamA = [all[0], all[3]];
                    teamB = [all[1], all[2]];
                }

                // Registrar compañero
                teamA[0].partners.push(teamA[1].id); teamA[1].partners.push(teamA[0].id);
                teamB[0].partners.push(teamB[1].id); teamB[1].partners.push(teamB[0].id);

                [...teamA, ...teamB].forEach(p => { p.played++; p.last = slot.mins; });

                matches.push({ mins: slot.mins, time: slot.time, court: slot.cName, t1: teamA, t2: teamB });
            }
        });
        showTab('fixture');
    }

    function renderFixture() {
        document.getElementById('fContent').innerHTML = matches.map((m, i) => `
            <div class="match-card">
                <div class="match-header"><span>PARTIDO #${i+1} - ${m.time}hs</span> <span>${m.court}</span></div>
                <div class="match-body">
                    <div>${m.t1[0].name} (${m.t1[0].cat})<br>${m.t1[1].name} (${m.t1[1].cat})</div>
                    <div style="font-weight:bold; color:#94a3b8">VS</div>
                    <div>${m.t2[0].name} (${m.t2[0].cat})<br>${m.t2[1].name} (${m.t2[1].cat})</div>
                </div>
            </div>
        `).join('');
    }

    renderPlayers(); renderCourts();
</script>
</body>
</html>
