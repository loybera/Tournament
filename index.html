<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Pro - Rotación Justa</title>
    <style>
        :root { --primary: #1e40af; --secondary: #10b981; --accent: #f59e0b; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; color: #1e293b; padding-bottom: 50px; }
        nav { background: #1e293b; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .tab-btn { background: none; border: none; color: #94a3b8; padding: 15px 15px; cursor: pointer; font-weight: 600; font-size: 0.8rem; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid var(--secondary); }
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .card.active { display: block; }
        textarea { width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: monospace; box-sizing: border-box; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 15px; }
        input, select, button { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .btn { cursor: pointer; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; }
        .btn-add { background: var(--primary); color: white; }
        .btn-gen { background: var(--secondary); color: white; width: 100%; font-size: 1.1rem; margin-top: 20px; }
        .match-card { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; background: white; }
        .match-header { background: #f8fafc; padding: 8px 15px; display: flex; justify-content: space-between; font-size: 0.8rem; border-bottom: 1px solid #e2e8f0; font-weight: bold; }
        .match-body { padding: 15px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 10px; text-align: center; }
        .score-input { width: 45px; text-align: center; font-size: 1.2rem; font-weight: bold; border: 2px solid #3b82f6; border-radius: 4px; }
        .badge { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.7rem; }
        .bg-cancha { background: #3b82f6; }
        .bg-hora { background: #64748b; }
        .player-list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav>
        <button class="tab-btn active" onclick="openTab(event, 'jugadores')">JUGADORES</button>
        <button class="tab-btn" onclick="openTab(event, 'canchas')">CANCHAS</button>
        <button class="tab-btn" onclick="openTab(event, 'fixture')">FIXTURE</button>
        <button class="tab-btn" onclick="openTab(event, 'posiciones')">POSICIONES</button>
    </nav>

    <div class="container">
        
        <div id="jugadores" class="card active">
            <h3>Carga Masiva de Jugadores</h3>
            <p><small>Formato: <code>Nombre, Categoría</code> (Ej: Juan Perez, 7)</small></p>
            <textarea id="bulkPlayers" placeholder="Juan Perez, 7&#10;Maria Garcia, 6"></textarea>
            <button class="btn btn-add" style="width:100%; margin-top:10px" onclick="importPlayers()">Importar Lista</button>
            <h4 style="margin-top:20px">Jugadores Registrados: <span id="pCount">0</span></h4>
            <div id="playerList"></div>
            <button class="btn" style="background:#ef4444; color:white; width:100%; margin-top:10px" onclick="resetPartidos()">Limpiar Jugadores y Fixture</button>
        </div>

        <div id="canchas" class="card">
            <h3>Configuración de Canchas</h3>
            <div class="grid-inputs">
                <input type="text" id="cName" placeholder="Nombre Cancha">
                <input type="time" id="cTime" value="18:00">
                <button class="btn btn-add" onclick="addCourt()">Añadir</button>
            </div>
            <div id="courtList"></div>
            <button class="btn btn-gen" onclick="generateTournament()">GENERAR FIXTURE CON PRIORIDAD</button>
        </div>

        <div id="fixture" class="card">
            <h3>Cronograma de Partidos</h3>
            <div id="fixtureContent"></div>
        </div>

        <div id="posiciones" class="card">
            <h3>Ranking Individual</h3>
            <div id="rankingContent"></div>
        </div>

    </div>

    <script>
        let players = JSON.parse(localStorage.getItem('tp_p')) || [];
        let courts = JSON.parse(localStorage.getItem('tp_c')) || [];
        let matches = JSON.parse(localStorage.getItem('tp_m')) || [];

        function openTab(evt, name) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            if(evt) evt.currentTarget.classList.add('active');
            if(name === 'posiciones') calculateRanking();
            if(name === 'fixture') renderFixture();
        }

        function importPlayers() {
            const text = document.getElementById('bulkPlayers').value;
            text.split('\n').forEach(line => {
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const name = parts[0].trim();
                    const cat = parseInt(parts[1].trim());
                    if(name && !isNaN(cat)) players.push({ 
                        id: Math.random().toString(36).substr(2, 9), 
                        name, 
                        cat,
                        matchesPlayed: 0,
                        lastTurn: -1 
                    });
                }
            });
            document.getElementById('bulkPlayers').value = '';
            save(); renderPlayers();
        }

        function renderPlayers() {
            document.getElementById('pCount').innerText = players.length;
            document.getElementById('playerList').innerHTML = players.map((p, i) => `
                <div class="player-list-item">
                    <span>${p.name} <strong>(Cat ${p.cat}°)</strong></span>
                    <button onclick="removePlayer(${i})" style="color:red; background:none; border:none; cursor:pointer">✕</button>
                </div>
            `).join('');
        }
        function removePlayer(i) { players.splice(i,1); save(); renderPlayers(); }

        function addCourt() {
            const name = document.getElementById('cName').value;
            const time = document.getElementById('cTime').value;
            if(name && time) {
                courts.push({ id: Date.now(), name, startTime: time });
                save(); renderCourts();
            }
        }
        function renderCourts() {
            document.getElementById('courtList').innerHTML = courts.map((c, i) => `
                <div class="player-list-item">
                    <span><span class="badge bg-cancha">${c.name}</span> Inicio: ${c.startTime} hs</span>
                    <button onclick="removeCourt(${i})" style="color:red; background:none; border:none; cursor:pointer">✕</button>
                </div>
            `).join('');
        }
        function removeCourt(i) { courts.splice(i,1); save(); renderCourts(); }

        function generateTournament() {
            if(players.length < 4 || courts.length < 1) return alert("Faltan jugadores o canchas");
            matches = [];
            
            // Reiniciamos contadores internos para el algoritmo de prioridad
            players.forEach(p =>
